<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">

<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="./poly-helper-behavior.html">
<link rel="import" href="./matrix-behavior.html">

<dom-module id="matrix-settings">
  <template>
    <style is="custom-style">
      :host {
        display: flex;
        flex-direction: column;
        justify-content: center;
        background: white;
        color: black;
        padding: 5em;
        box-shadow: rgba(0, 0, 0, 0.24) -2px 5px 12px 0px, rgba(0, 0, 0, 0.12) 0px 0px 12px 0px;
      }
      .on {
        color: blue
      }
      paper-icon-button[icon="settings-power"] {
        width: 5em;
        height: 5em;
      }

      paper-icon-button[icon="remove-circle"] {
        color: black;
        width: 2em;
        height: 2em;
      }

    </style>
    <div>
      <paper-icon-button icon="settings-power" class$="[[_classBinding(settings.filterOn, 'on')]]" on-tap="toggle"></paper-icon-button>
      <div>Flag Kill threshold: </div>
      <paper-slider id="flagKillThreshold" min="0" max="100" value="{{settings.flagKillThreshold}}" editable></paper-slider>
      <div>Auto-collapse below vote threshold: </div>
      <paper-slider id="voteCollapseThreshold" min="-200" max="200" value="{{settings.voteCollapseThreshold}}" editable></paper-slider>
      <div> Moderator Identities: </div>
      <div class="moderator-list" class$="[[_classBinding(settings.filterOn, 'on')]]">
        <template is="dom-repeat" items="[[trustedIdentities]]" as="identity">
          <p> [[identity]]<paper-icon-button icon="remove-circle" on-tap='removeIdentity' value="[[identity]]"></paper-icon-button>
        </template></p>
      </div>
    </div>
    <paper-input value='{{newIdentity}}' label="Add trusted identities" on-keydown="identityInput"></paper-input>
  </template>

<script>
  Polymer({

    is: 'matrix-settings',
    behaviors: [
      MatrixBehavior,
      Polymer.IronOverlayBehavior,
      PolyHelperBehavior,
      SharedStateBehavior
    ],
    observers: [
      'settingsUpdated(settings.*)',
      'loadSettings(clientReady)'
    ],
    properties: {
      loadedSettings: {
        type: Object,
        value: null
      },
      settings: {
        type: Object,
        value() { return this.defaultSettings() },
        notify: true,
      },

      clientReady: {
        type: Boolean,
        value: false,
      },
      trustedIdentities: {
        type: Array,
        value: function() {
          return []
        },
        computed: '_objectKeys(settings.trustedIdentities)'
      },
      userId: {
        type: String,
      },
      newIdentity: {
        type: String,
        value: '',
        notify: true
      }
    },

    identityInput(e) {
      if (e.keyCode == 13) {
        this.settings.trustedIdentities[this.newIdentity] = {}
        this.newIdentity = ''
        this.notifyPath('settings.trustedIdentities')
      }
    },

    removeIdentity(event) {
      var identity = event.currentTarget.value
      delete this.trustedIdentities[identity]
      this.notifyPath('settings.trustedIdentities.*')
    },

    settingsIsDirty() {
      const loadedSettings = this.loadedSettings || this.defaultSettings()
      const settings = this.settings
      return true
    },

    settingsUpdated() {
      if (this.settingsIsDirty()) {
        this.debounce('persistSettings', this.persistSettings.bind(this), 5000)
        this.fire('settings-updated')
      }
    },

    persistSettings() {
      this.saveUserSettings(this.settings)
    },

    loadSettings(clientReady) {
      if (!clientReady) return
      this.loadUserSettings().then((result) => {
        if (result.tags && result.tags.settings) {
          this.set('loadedSettings', result.tags.settings)
          window.settings = result.tags.settings
          this.set('settings', result.tags.settings)
        }
      })
    },

    toggle(selector) {
      var filterOn = !this.settings.filterOn
      this.settings.filterOn = filterOn
      this.$.flagKillThreshold.disabled = !filterOn
      this.$.voteCollapseThreshold.disabled = !filterOn
      this.notifyPath('settings.filterOn')
    },


  });
</script>
</dom-module>
