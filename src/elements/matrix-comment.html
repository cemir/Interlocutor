
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">

<link rel="import" href="../../bower_components/shared-state-behavior/shared-state-behavior.html">

<link rel="import" href="./matrix-reply.html">
<link rel="import" href="./poly-helper-behavior.html">
<link rel="import" href="./matrix-behavior.html">

<dom-module id="matrix-comment">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        max-height: 20em;
      }
      .comment-children {
        margin-left: 2em;
      }
      #commentBody {
        margin-left: 1.6em;
        margin-top: 0.4em;
      }
      #commentBodyText {
        background: #FFF4CD;
      }
      #commentRowOne {
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        align-items: center;
      }
      .comment-posted-at {
        color: #939393
      }
      .edit-icon {
        height: 2em;
        width: 2em;
      }
      .flagged {
        color: red;
      }

    </style>
    <div class='comment-row1-wrapper'>
      <div class='comment-body-wrapper collapse-comment'>
        <div id="commentRowOne">
          <template is="dom-if" if="[[commentBodyOpen]]">
            <iron-image src="[[avatarUrl]]" style="width:1.8em; height:1.8em" sizing="contain"></iron-image>
          </template>
          <span class='comment-author-name'>[[commentAuthor]]</span>
          <span class='comment-posted-at'>[[postedAt(comment.origin_server_ts)]]</span>
          <template is="dom-if" if="[[canUpVote]]">
            <paper-icon-button
              class='upvote-comment'
              icon$="[[_classBinding(upVoted, 'icons:star', 'icons:star-border')]]"
              on-tap="toggleUpVote">
            </paper-icon-button>
          </template>
          <template is="dom-if" if="[[canEdit]]">
            <span>
              <paper-icon-button
                icon='create'
                class="edit-icon"
                on-tap="openEditOverlay">
              </paper-icon-button>
            </span>
          </template>
          <template is="dom-if" if="[[canFlag]]">
            <span>
              <paper-icon-button
                icon='flag'
                class$="[[_classBinding(isFlagged, 'flagged')]]"
                id="flagIcon"
                on-tap="toggleFlag">
              </paper-icon-button>
            </span>
          </template>
          <paper-icon-button class="heading"
            aria-expanded$="[[commentBodyOpen]]"
            aria-controls="commentBodyCollapse"
            on-tap="toggleCollapse"
            icon$="[[_classBinding(commentBodyOpen, 'expand-less', 'expand-more')]]">
            -
          </paper-icon-button>
        </div>
        <iron-collapse id="commentBodyCollapse" tabindex="0" opened="[[commentBodyOpen]]">
          <div id='commentBody'>
            <span id='commentBodyText'>[[text]]</span>
          </div>
        </iron-collapse>
      </div>
    </div>
    <iron-collapse id="commentRowTwo" tabindex="0" opened="[[commentBodyOpen]]">
      <div class='comment-row2-wrapper'>
        <template is="dom-if" if="[[canReply(userId, comment)]]">
          <paper-button class='comment-reply' on-tap="openReplyOverlay">[reply]</paper-button>
        </template>
        <!-- <template is="dom-if" if="[[replyOpen]]"> -->
        <!-- </template> -->
      </div>
      <div class='comment-children'>
        <template is="dom-repeat" items="[[children]]" as="comment">
          <matrix-comment id="[[comment.event_id]]" comment="[[comment]]" state="[[state]]" user-id="[[userId]]" last-updated="[[lastUpdated]]"></matrix-comment>
        </template>
      </div>
    </iron-collapse>
    <matrix-reply id="reply" tabindex="-1" with-backdrop></matrix-reply>
  </template>

  <script>
    Polymer({

      is: 'matrix-comment',
      behaviors: [
        PolyHelperBehavior,
        MatrixBehavior,
        SharedStateBehavior
      ],
      listeners: {
        'cancel': 'toggleReply',
        'flags-updated': '_recomputeChildrenFromEvent',
      },
      observers: [
        '_onFlagged(flagged.*)',
        // '_recomputeChildren(lastUpdated)'
      ],
      properties: {
        state: {
          type: Object,
          value: function() { return {} },
        },
        comment: {
          type: Object,
          value: function() { return {} },
          notify: true,
        },

        dataChildren: {
          type: Array,
          value: function() { return [] },
          computed: '_alias(comment.children)'
        },

        children: {
          type: Array,
          value: function() { return [] },
          computed: '_children(dataChildren.*, lastUpdated)',
        },

        childrenCount: {
          type: Number,
          value: 0,
          computed: '_count(children.splices, children)'
        },
        body: {
          type: Object,
          value: function() { return {} },
          computed: '_alias(comment.content.body)'
        },
        text: {
          type: String,
          value: '',
          computed: '_text(comment, body)'
        },
        commentBodyOpen: {
          type: Boolean,
          value: true,
        },
        authorName: {
          type: String,
          value: 'pik'
        },
        commentDate: {
          type: String,
          value: 'Edited 1 hour ago'
        },
        replyOpen: {
          type: Boolean,
          value: false,
          notify: true,
        },
        userId: {
          type: String,
          value: null,
          notify: true
        },
        canEdit: {
          type: Boolean,
          value: false,
          computed: '_canEdit(userId, comment)'
        },
        canFlag: {
          type: Boolean,
          value: false,
          computed: '_canFlag(userId, comment)'
        },
        canUpVote: {
          type: Boolean,
          value: false,
          computed: '_canUpVote(userId, comment)'
        },
        flagged: {
          type: Object,
          computed: '_alias(comment.flagged)'
        },
        isFlagged: {
          type: Boolean,
          value: false,
          computed: '_isFlagged(flagged.*)'
        },
        upVoted: {
          type: Boolean,
          value: false,
          computed: '_upVoted(lastUpdated)'
        },
        commentAuthor: {
          type: String,
          value: '',
          computed: '_commentAuthor(lastUpdated)'
        },
        avatarUrl: {
          type: String,
          value: '',
          computed: '_avatarUrl(commentAuthor)'
        }
      },

      attached() {
        this.comment.children.addListener(this, 'dataChildren')
        this.notifyPath('flagged.*', this.flagged)
      },

      dettached() {
        this.comment.children.removeListener(this, 'dataChildren')
      },

      _recomputeChildren(_) {
        this._pathEffector('dataChildren.*', this.dataChildren)
      },

      _recomputeChildrenFromEvent(event, source) {
        // Because fire goes to back to itself by default...
        if (source !== this) {
          event.preventDefault()
          // Because Polymer has no hard recompute
          this._pathEffector('dataChildren.*', this.dataChildren)
        }
      },

      _onFlagged() {
        this.fire('flags-updated', this, { cancelable: true })
      },

      _avatarUrl(user_id) {
        return user_id ? client.getUser(user_id).avatarUrl : ''
      },

      _commentAuthor() {
        return this.comment.user_id || this.comment.sender
      },

      _upVoted() {
        const vote = this.comment.voted[this.userId]
        return !!(vote && vote.content.body.value === 1)
      },

      _isFlagged(_) {
        return this.flagged[this.userId]
      },

      toggleUpVote() {
        // A downvote sends a -1, an Upvote a +1
        // an un - UpVote or un-DownVote a 0
        // Currently only UpVote(*Star*) supported
        this.sendVoteComment(this.comment.event_id, this.upVoted ? 0 : 1)
      },


      toggleFlag() {
        this.sendFlagComment(this.comment.event_id, !this.isFlagged).then((success) => {
        }, (error) => {
          console.log(error)
          // this.flagged = !this.flagged
        })
      },

      _text() {
        return this.body.text
      },

      // _dataChildren(comment, state) {
      //   if (this.state[comment.event_id]) {
      //     return this.state[comment.event_id]
      //   } else {
      //     this.state[comment.event_id] = []
      //     return this.state[comment.event_id]
      //   }
      // },

      _children(_) {
        console.log('filtering _children', this.id)
        return this.dataChildren.filter((comment) => {
          return comment.content.msgtype === 'm.comment' && this.permitted(comment)
        })
      },

      _canEdit(userId, comment) {
        return userId && comment && (comment.user_id === userId)
      },

      _canUpVote(userId, comment) {
        return userId // && comment && (comment.user_id !== userId)
      },

      _canFlag(userId, comment) {
        return userId // && comment && (comment.user_id !== userId)
      },

      canReply(userId, comment) {
        return userId // && comment && (comment.user_id !== userId)
      },

      openReplyOverlay() {
        this.$.reply.targetId = this.comment.event_id
        this.$.reply.action = 'm.comment'
        this.$.reply.open()
      },

      openEditOverlay() {
        this.$.reply.targetId = this.comment.event_id
        this.$.reply.action = 'm.edit'
        this.$.reply.content = this.body.text
        this.$.reply.open()
      },

      toggleCollapse(_) {
        this.commentBodyOpen = !this.commentBodyOpen
      },

      postedAt(timestamp) {
        return moment(timestamp).fromNow()
      }

    });
  </script>
</dom-module>
