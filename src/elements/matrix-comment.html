
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="./matrix-reply.html">
<link rel="import" href="./poly-helper-behavior.html">
<link rel="import" href="./matrix-behavior.html">

<dom-module id="matrix-comment">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        max-height: 20em;
      }
      .comment-children {
        margin-left: 2em;
      }
      #commentBody {
        margin-left: 2em;
        background: #FFF4CD
      }
      .comment-posted-at {
        color: #939393
      }
      .edit-icon {
        height: 2em;
        width: 2em;
      }
      .flagged {
        color: red;
      }

    </style>
    <div class='comment-row1-wrapper'>
      <template is="dom-if" if="[[canUpVote]]">
        <paper-icon-button class='upvote-comment'></paper-icon-button>
      </template>
      <div class='comment-body-wrapper collapse-comment'>
        <div>
          <span class='comment-author-name'>[[commentAuthor]]</span>
          <span class='comment-posted-at'>[[postedAt(comment.origin_server_ts)]]</span>
          <template is="dom-if" if="[[canEdit]]">
            <span> <paper-icon-button icon='create' class="edit-icon" on-tap="openEditOverlay"></paper-icon-button> </span>
          </template>
          <template is="dom-if" if="[[canFlag]]">
            <span> <paper-icon-button icon='flag' class$="[[_classBinding(flagged, 'flagged')]]" id="flagIcon" on-tap="toggleFlag"></paper-icon-button> </span>
          </template>
          <paper-icon-button class="heading"
            aria-expanded$="[[commentBodyOpen]]"
            aria-controls="commentBodyCollapse"
            on-tap="toggleCollapse"
            icon$="[[_classBinding(commentBodyOpen, 'expand-less', 'expand-more')]]">
            -
          </paper-icon-button>
        </div>
        <iron-collapse id="commentBodyCollapse" tabindex="0" opened="[[commentBodyOpen]]">
          <span id='commentBody'>[[text]]</span>
        </iron-collapse>

      </div>
    </div>
    <iron-collapse id="commentRowTwo" tabindex="0" opened="[[commentBodyOpen]]">
      <div class='comment-row2-wrapper'>
        <template is="dom-if" if="[[canReply(userId)]]">
          <paper-button class='comment-reply' on-tap="openReplyOverlay">[reply]</paper-button>
        </template>
        <!-- <template is="dom-if" if="[[replyOpen]]"> -->
        <!-- </template> -->
      </div>
      <div class='comment-children'>
        <template is="dom-repeat" items="[[children]]" as="comment">
          <matrix-comment id="[[comment.event_id]]" comment="[[comment]]" state="[[state]]" user-id="[[userId]]" last-updated="[[lastUpdated]]"></matrix-comment>
        </template>
      </div>
    </iron-collapse>
    <matrix-reply id="reply" tabindex="-1" with-backdrop></matrix-reply>
  </template>

  <script>
    Polymer({

      is: 'matrix-comment',
      behaviors: [
        PolyHelperBehavior,
        MatrixBehavior
      ],
      listeners: {
        'cancel': 'toggleReply',
      },
      properties: {
        state: {
          type: Object,
          value: function() { return {} },
        },
        comment: {
          type: Object,
          value: function() { return {} },
          notify: true,
        },

        dataChildren: {
          type: Array,
          value: function() { return [] },
          computed: '_alias(comment.children)'
        },

        children: {
          type: Array,
          value: function() { return [] },
          computed: '_children(dataChildren.splices)',
        },

        childrenCount: {
          type: Number,
          value: 0,
          computed: '_count(children.splices, children)'
        },
        body: {
          type: Object,
          value: function() { return {} },
          computed: '_alias(comment.content.body)'
        },
        text: {
          type: String,
          value: '',
          computed: '_text(lastUpdated)'
        },
        commentBodyOpen: {
          type: Boolean,
          value: true,
        },
        authorName: {
          type: String,
          value: 'pik'
        },
        commentDate: {
          type: String,
          value: 'Edited 1 hour ago'
        },
        replyOpen: {
          type: Boolean,
          value: false,
          notify: true,
        },
        userId: {
          type: String,
          value: null,
          notify: true
        },
        canEdit: {
          type: Boolean,
          value: false,
          computed: '_canEdit(userId, comment)'
        },
        canFlag: {
          type: Boolean,
          value: false,
          computed: '_canFlag(userId, comment)'
        },
        flagged: {
          type: Boolean,
          value: false,
          computed: '_flagged(lastUpdated)'
        },
        commentAuthor: {
          type: String,
          value: '',
          computed: '_commentAuthor(lastUpdated)'
        }
      },
      attached() {
        this.comment.children.addListener(this, 'dataChildren')
      },

      dettached() {
        this.comment.children.removeListener(this, 'dataChildren')
      },

      _commentAuthor() {
        return this.comment.user_id || this.comment.sender
      },

      _flagged() {
        return this.comment.flagged[this.userId]
      },

      toggleFlag() {
        this.sendFlagComment(this.comment.event_id, !this.flagged).then((success) => {
        }, (error) => {
          console.log(error)
          // this.flagged = !this.flagged
        })
      },

      _text() {
        return this.body.text
      },

      // _dataChildren(comment, state) {
      //   if (this.state[comment.event_id]) {
      //     return this.state[comment.event_id]
      //   } else {
      //     this.state[comment.event_id] = []
      //     return this.state[comment.event_id]
      //   }
      // },

      _children(_) {
        return this.dataChildren.filter((comment) => {
          return comment.content.msgtype === 'm.comment' && this.permitted(comment)
        })
      },

      _canEdit: function(userId, comment) {
        return userId && comment && (comment.user_id === userId)
      },

      _canFlag: function(userId, _) {
        return userId
      },

      canReply: function(userId) {
        return userId
      },

      openReplyOverlay: function() {
        this.$.reply.targetId = this.comment.event_id
        this.$.reply.action = 'm.comment'
        this.$.reply.open()
      },

      openEditOverlay: function() {
        this.$.reply.targetId = this.comment.event_id
        this.$.reply.action = 'm.edit'
        this.$.reply.content = this.body.text
        this.$.reply.open()
      },

      toggleCollapse: function(_) {
        this.commentBodyOpen = !this.commentBodyOpen
      },

      postedAt: function(timestamp) {
        return moment(timestamp).fromNow()
      }

    });
  </script>
</dom-module>
